<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shadow Market</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root {
  --bg: #020308;
  --bg-alt: #050814;
  --panel: #0c1020;
  --panel-soft: #090c18;
  --accent: #7b5cff;
  --accent-soft: rgba(123, 92, 255, 0.2);
  --accent-strong: #c45bff;
  --danger: #ff4b81;
  --text: #f5f7ff;
  --muted: #8f96c2;
  --border: #1c2136;
  --radius: 8px;
  --shadow: 0 0 25px rgba(0,0,0,0.7);
  --font: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: var(--font);
  background: radial-gradient(circle at top, #171b33 0, #020308 55%);
  color: var(--text);
  height: 100vh;
}

/* LAYOUT */
#app {
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* SIDEBAR */
#sidebar {
  width: 260px;
  background: linear-gradient(180deg, var(--bg-alt), #020308);
  border-right: 1px solid var(--border);
  padding: 12px;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow);
}

#sidebar-header {
  margin-bottom: 14px;
}

#brand {
  font-size: 0.95rem;
  font-weight: 700;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

#brand span.mark {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 999px;
  background: var(--accent);
  margin-right: 4px;
  font-size: 0.7rem;
}

#brand-sub {
  font-size: 0.75rem;
  color: var(--muted);
}

.sidebar-section-title {
  font-size: 0.75rem;
  text-transform: uppercase;
  color: var(--muted);
  margin: 10px 0 6px;
}

.sidebar-btn {
  padding: 7px 9px;
  margin-bottom: 4px;
  background: transparent;
  border-radius: 6px;
  border: 1px solid transparent;
  cursor: pointer;
  text-align: left;
  color: var(--muted);
  font-size: 0.85rem;
  display: flex;
  align-items: center;
  gap: 6px;
}

.sidebar-btn span.icon {
  width: 20px;
  text-align: center;
}

.sidebar-btn:hover {
  background: var(--accent-soft);
  color: var(--text);
}

.sidebar-btn.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent-strong);
}

#sidebar-footer {
  margin-top: auto;
  font-size: 0.7rem;
  color: var(--muted);
  border-top: 1px solid var(--border);
  padding-top: 8px;
}

/* MAIN WRAPPER */
#main-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* TOPBAR */
#topbar {
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  border-bottom: 1px solid var(--border);
  background: rgba(2,3,8,0.95);
  backdrop-filter: blur(10px);
}

#topbar-left {
  font-size: 0.85rem;
  color: var(--muted);
}

#topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 0.8rem;
}

#status-pill {
  padding: 2px 8px;
  border-radius: 999px;
  background: var(--accent-soft);
  color: var(--accent);
  font-size: 0.7rem;
  text-transform: uppercase;
}

#user-pill {
  display: flex;
  align-items: center;
  gap: 6px;
}

#user-avatar {
  width: 22px;
  height: 22px;
  border-radius: 999px;
  background: linear-gradient(135deg, var(--accent), var(--accent-strong));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7rem;
  font-weight: 700;
}

/* MAIN CONTENT */
#main {
  flex: 1;
  padding: 14px 16px;
  overflow-y: auto;
  position: relative;
}

/* PAGES */
.page {
  display: none;
}

.page.active {
  display: block;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.page-header h1 {
  margin: 0;
  font-size: 1.2rem;
}

.page-header p {
  margin: 4px 0 0;
  font-size: 0.85rem;
  color: var(--muted);
}

/* GRID / CARDS */
.grid {
  display: grid;
  gap: 12px;
}

.grid-2 {
  grid-template-columns: repeat(2, minmax(0, 1fr));
}

.grid-3 {
  grid-template-columns: repeat(3, minmax(0, 1fr));
}

.card {
  background: var(--panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 10px 12px;
  box-shadow: var(--shadow);
  font-size: 0.9rem;
}

.card h2 {
  margin: 0 0 6px;
  font-size: 1rem;
}

.card small {
  color: var(--muted);
}

/* BUTTONS */
.btn {
  padding: 7px 12px;
  border-radius: 999px;
  border: 1px solid transparent;
  background: var(--accent);
  color: #fff;
  font-size: 0.85rem;
  cursor: pointer;
}

.btn.secondary {
  background: transparent;
  border-color: var(--accent-soft);
  color: var(--text);
}

.btn.danger {
  background: var(--danger);
}

.btn.small {
  padding: 4px 8px;
  font-size: 0.75rem;
}

.btn + .btn {
  margin-left: 6px;
}

/* MARKETPLACE */
.market-layout {
  display: grid;
  grid-template-columns: 220px minmax(0, 1fr);
  gap: 12px;
}

.market-filters {
  background: var(--panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 10px;
  font-size: 0.85rem;
}

.market-filters label {
  display: block;
  margin-top: 6px;
  margin-bottom: 2px;
  font-size: 0.8rem;
  color: var(--muted);
}

.market-filters select,
.market-filters input {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #020308;
  color: var(--text);
  font-size: 0.8rem;
}

.market-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
  gap: 10px;
}

.item-card {
  background: var(--panel-soft);
  border-radius: 8px;
  border: 1px solid var(--border);
  padding: 8px;
  font-size: 0.85rem;
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.item-tag {
  font-size: 0.7rem;
  text-transform: uppercase;
  color: var(--muted);
}

.item-title {
  font-weight: 600;
}

.item-meta {
  font-size: 0.75rem;
  color: var(--muted);
}

.item-price {
  font-size: 0.85rem;
  color: var(--accent-strong);
}

/* CART DRAWER */
#cart-drawer {
  position: fixed;
  right: 16px;
  bottom: 16px;
  width: 260px;
  max-height: 60vh;
  background: var(--panel);
  border-radius: 10px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  padding: 10px;
  font-size: 0.85rem;
  display: none;
  flex-direction: column;
}

#cart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#cart-items {
  margin-top: 6px;
  max-height: 200px;
  overflow-y: auto;
}

.cart-item {
  padding: 4px 0;
  border-bottom: 1px solid var(--border);
}

.cart-item:last-child {
  border-bottom: none;
}

#cart-footer {
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* MESSAGES */
.messages-layout {
  display: grid;
  grid-template-columns: 220px minmax(0, 1fr);
  gap: 12px;
}

.thread-list {
  background: var(--panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 8px;
  font-size: 0.85rem;
}

.thread-item {
  padding: 6px 8px;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 4px;
}

.thread-item.active,
.thread-item:hover {
  background: var(--accent-soft);
}

.thread-main {
  background: var(--panel);
  border-radius: var(--radius);
  border: 1px solid var(--border);
  padding: 8px;
  font-size: 0.85rem;
  display: flex;
  flex-direction: column;
  height: 100%;
}

#thread-messages {
  flex: 1;
  overflow-y: auto;
  padding-right: 4px;
}

.msg-bubble {
  margin-top: 6px;
  padding: 6px 8px;
  border-radius: 6px;
  max-width: 80%;
  font-size: 0.8rem;
}

.msg-bubble.me {
  margin-left: auto;
  background: var(--accent-soft);
}

.msg-bubble.them {
  background: var(--panel-soft);
}

#msg-form {
  margin-top: 6px;
  display: flex;
  gap: 6px;
}

#msg-input {
  flex: 1;
  padding: 6px 8px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: #020308;
  color: var(--text);
  font-size: 0.8rem;
}

/* ORDERS */
.order-item {
  padding: 6px 8px;
  border-radius: 6px;
  background: var(--panel-soft);
  border: 1px solid var(--border);
  margin-bottom: 6px;
  font-size: 0.85rem;
}

/* PROFILE */
.profile-grid {
  display: grid;
  grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
  gap: 12px;
}

.profile-card label {
  display: block;
  margin-top: 6px;
  margin-bottom: 2px;
  font-size: 0.8rem;
  color: var(--muted);
}

.profile-card input,
.profile-card textarea {
  width: 100%;
  padding: 6px 8px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: #020308;
  color: var(--text);
  font-size: 0.85rem;
}

.profile-card textarea {
  resize: vertical;
}

/* RESPONSIVE */
@media (max-width: 1000px) {
  #sidebar {
    display: none;
  }
  #app {
    flex-direction: column;
  }
  #main {
    padding: 10px;
  }
  .market-layout,
  .messages-layout,
  .profile-grid {
    grid-template-columns: minmax(0, 1fr);
  }
}
</style>
</head>
<body>

<div id="app">
  <!-- SIDEBAR -->
  <div id="sidebar">
    <div id="sidebar-header">
      <div id="brand"><span class="mark">SM</span>SHADOW MARKET</div>
      <div id="brand-sub">Fictional dark marketplace UI</div>
    </div>

    <div class="sidebar-section-title">Main</div>
    <button class="sidebar-btn active" data-page="dashboard">
      <span class="icon">üè†</span> Dashboard
    </button>
    <button class="sidebar-btn" data-page="market">
      <span class="icon">üõí</span> Marketplace
    </button>
    <button class="sidebar-btn" data-page="messages">
      <span class="icon">üí¨</span> Messages
    </button>
    <button class="sidebar-btn" data-page="orders">
      <span class="icon">üì¶</span> Orders
    </button>
    <button class="sidebar-btn" data-page="profile">
      <span class="icon">üë§</span> Profile
    </button>

    <div class="sidebar-section-title">Admin</div>
    <button class="sidebar-btn" data-page="admin">
      <span class="icon">üõ†</span> Admin Panel
    </button>

    <div id="sidebar-footer">
      Shadow Market UI ‚Ä¢ Local only<br>
      <span id="footer-year"></span>
    </div>
  </div>

  <!-- MAIN WRAPPER -->
  <div id="main-wrapper">
    <!-- TOPBAR -->
    <div id="topbar">
      <div id="topbar-left">
        <span id="topbar-page-label">Dashboard</span> ‚Ä¢ Shadow layer: <strong>Local Sandbox</strong>
      </div>
      <div id="topbar-right">
        <span id="status-pill">Offline / Mock</span>
        <div id="user-pill">
          <div id="user-avatar">ST</div>
          <span>Owner</span>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main">
      <!-- DASHBOARD -->
      <div id="page-dashboard" class="page active">
        <div class="page-header">
          <div>
            <h1>Dashboard</h1>
            <p>Overview of your fictional Shadow Market activity.</p>
          </div>
        </div>

        <div class="grid grid-3">
          <div class="card">
            <h2>Market Snapshot</h2>
            <small>Fake stats, real vibes.</small>
            <p style="margin-top:6px;">
              Active listings: <strong id="stat-listings">0</strong><br>
              Orders (local): <strong id="stat-orders">0</strong><br>
              Threads: <strong id="stat-threads">0</strong>
            </p>
          </div>
          <div class="card">
            <h2>Quick Actions</h2>
            <button class="btn small" onclick="goTo('market')">Browse Marketplace</button>
            <button class="btn small secondary" onclick="goTo('messages')">Open Messages</button>
            <button class="btn small secondary" onclick="goTo('orders')">View Orders</button>
          </div>
          <div class="card">
            <h2>Disclaimer</h2>
            <p style="font-size:0.8rem; color:var(--muted);">
              This is a UI sandbox only. No real transactions, no real network calls, no real marketplace. Use it as a design playground.
            </p>
          </div>
        </div>
      </div>

      <!-- MARKETPLACE -->
      <div id="page-market" class="page">
        <div class="page-header">
          <div>
            <h1>Marketplace</h1>
            <p>Browse fictional listings and add them to your local cart.</p>
          </div>
          <div>
            <button class="btn small secondary" onclick="toggleCart()">Cart (<span id="cart-count">0</span>)</button>
          </div>
        </div>

        <div class="market-layout">
          <div class="market-filters">
            <h3 style="margin-top:0; font-size:0.9rem;">Filters</h3>
            <label for="filter-category">Category</label>
            <select id="filter-category" onchange="renderMarket()">
              <option value="all">All</option>
              <option value="access">Access</option>
              <option value="tools">Tools</option>
              <option value="data">Data</option>
              <option value="services">Services</option>
            </select>

            <label for="filter-sort">Sort by</label>
            <select id="filter-sort" onchange="renderMarket()">
              <option value="featured">Featured</option>
              <option value="price-asc">Price: Low to High</option>
              <option value="price-desc">Price: High to Low</option>
            </select>

            <label for="filter-search">Search</label>
            <input id="filter-search" placeholder="Search titles..." oninput="renderMarket()">
          </div>

          <div class="market-grid" id="market-grid"></div>
        </div>
      </div>

      <!-- MESSAGES -->
      <div id="page-messages" class="page">
        <div class="page-header">
          <div>
            <h1>Messages</h1>
            <p>Fake encrypted threads with fictional vendors.</p>
          </div>
        </div>

        <div class="messages-layout">
          <div class="thread-list" id="thread-list"></div>
          <div class="thread-main">
            <div id="thread-header" style="font-size:0.85rem; color:var(--muted);">
              Select a thread on the left.
            </div>
            <div id="thread-messages"></div>
            <div id="msg-form">
              <input id="msg-input" placeholder="Send a message..." disabled>
              <button class="btn small" onclick="sendMessage()" disabled id="msg-send-btn">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ORDERS -->
      <div id="page-orders" class="page">
        <div class="page-header">
          <div>
            <h1>Orders</h1>
            <p>Local ‚Äúorders‚Äù created when you checkout your cart.</p>
          </div>
        </div>

        <div id="orders-list"></div>
      </div>

      <!-- PROFILE -->
      <div id="page-profile" class="page">
        <div class="page-header">
          <div>
            <h1>Profile</h1>
            <p>Local profile settings for this Shadow Market UI.</p>
          </div>
        </div>

        <div class="profile-grid">
          <div class="card profile-card">
            <h2>Identity</h2>
            <label for="profile-handle">Handle</label>
            <input id="profile-handle" placeholder="ShadowOwner">

            <label for="profile-bio">Bio</label>
            <textarea id="profile-bio" rows="3" placeholder="Short description..."></textarea>

            <label for="profile-theme">Theme Accent</label>
            <input id="profile-theme" placeholder="#7b5cff">

            <div style="margin-top:8px; text-align:right;">
              <button class="btn small secondary" onclick="resetProfile()">Reset</button>
              <button class="btn small" onclick="saveProfile()">Save</button>
            </div>
          </div>
          <div class="card">
            <h2>Local Data</h2>
            <p style="font-size:0.85rem;">
              All data (cart, orders, messages, profile) is stored in <code>localStorage</code> only.
            </p>
            <button class="btn small danger" onclick="clearAllData()">Clear All Local Data</button>
          </div>
        </div>
      </div>

      <!-- ADMIN -->
      <div id="page-admin" class="page">
        <div class="page-header">
          <div>
            <h1>Admin Panel</h1>
            <p>View raw JSON of your local Shadow Market state.</p>
          </div>
        </div>

        <div class="card">
          <h2>State Snapshot</h2>
          <pre id="admin-state" style="max-height:260px; overflow-y:auto; font-size:0.75rem; background:#020308; padding:8px; border-radius:6px; border:1px solid var(--border);"></pre>
          <button class="btn small secondary" onclick="refreshAdminState()">Refresh</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CART DRAWER -->
<div id="cart-drawer">
  <div id="cart-header">
    <strong>Cart</strong>
    <button class="btn small secondary" onclick="toggleCart()">Close</button>
  </div>
  <div id="cart-items"></div>
  <div id="cart-footer">
    <span>Total: <strong id="cart-total">0</strong> cr</span>
    <button class="btn small" onclick="checkout()">Checkout</button>
  </div>
</div>

<script>
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

document.getElementById('footer-year').textContent = new Date().getFullYear();

/* NAV */
$$('.sidebar-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const page = btn.getAttribute('data-page');
    goTo(page);
  });
});

function goTo(page) {
  $$('.sidebar-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector(\`.sidebar-btn[data-page="\${page}"]\`);
  if (activeBtn) activeBtn.classList.add('active');

  $$('.page').forEach(p => p.classList.remove('active'));
  const pageDiv = document.getElementById('page-' + page);
  if (pageDiv) pageDiv.classList.add('active');

  $('#topbar-page-label').textContent = page
    .split('-')
    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
    .join(' ');
}

/* DATA */
const listings = [
  { id: 'acc-01', title: 'Shadow Access Node', category: 'access', price: 120, vendor: 'GhostLayer', rating: 4.8 },
  { id: 'tool-01', title: 'Packet Trace Visualizer', category: 'tools', price: 60, vendor: 'TraceLab', rating: 4.5 },
  { id: 'data-01', title: 'Synthetic Log Dataset', category: 'data', price: 45, vendor: 'LogForge', rating: 4.2 },
  { id: 'svc-01', title: 'UI Wireframe Session', category: 'services', price: 90, vendor: 'ShadowUX', rating: 4.9 },
  { id: 'tool-02', title: 'Local Sandbox Monitor', category: 'tools', price: 35, vendor: 'SandboxOps', rating: 4.1 },
  { id: 'acc-02', title: 'Mock API Gateway', category: 'access', price: 75, vendor: 'MockNet', rating: 4.3 }
];

let cart = JSON.parse(localStorage.getItem('sm_cart') || '[]');
let orders = JSON.parse(localStorage.getItem('sm_orders') || '[]');

const threadsSeed = [
  {
    id: 'ghostlayer',
    name: 'GhostLayer',
    preview: 'Shadow Access Node details...',
    messages: [
      { from: 'them', text: 'Welcome to GhostLayer. All items here are fictional.', time: '00:01' },
      { from: 'them', text: 'Use this UI as a design sandbox only.', time: '00:02' }
    ]
  },
  {
    id: 'shadowux',
    name: 'ShadowUX',
    preview: 'Wireframe session notes...',
    messages: [
      { from: 'them', text: 'We can mock up any layout you want.', time: '00:03' }
    ]
  }
];

let threads = JSON.parse(localStorage.getItem('sm_threads') || 'null') || threadsSeed;
let currentThreadId = null;

let profile = JSON.parse(localStorage.getItem('sm_profile') || 'null') || {
  handle: 'ShadowOwner',
  bio: 'Owner of this fictional Shadow Market UI.',
  theme: '#7b5cff'
};

/* MARKET RENDER */
function renderMarket() {
  const grid = $('#market-grid');
  grid.innerHTML = '';

  const cat = $('#filter-category').value;
  const sort = $('#filter-sort').value;
  const search = $('#filter-search').value.toLowerCase();

  let items = listings.slice();
  if (cat !== 'all') items = items.filter(i => i.category === cat);
  if (search) items = items.filter(i => i.title.toLowerCase().includes(search));

  if (sort === 'price-asc') items.sort((a,b) => a.price - b.price);
  if (sort === 'price-desc') items.sort((a,b) => b.price - a.price);

  items.forEach(i => {
    const div = document.createElement('div');
    div.className = 'item-card';
    div.innerHTML = \`
      <div class="item-tag">\${i.category.toUpperCase()}</div>
      <div class="item-title">\${i.title}</div>
      <div class="item-meta">Vendor: \${i.vendor} ‚Ä¢ ‚≠ê \${i.rating}</div>
      <div class="item-price">\${i.price} cr</div>
      <div style="margin-top:4px; text-align:right;">
        <button class="btn small" onclick="addToCart('\${i.id}')">Add to cart</button>
      </div>
    \`;
    grid.appendChild(div);
  });

  $('#stat-listings').textContent = listings.length;
}

/* CART */
function addToCart(id) {
  const item = listings.find(l => l.id === id);
  if (!item) return;
  cart.push({ id: item.id, title: item.title, price: item.price });
  localStorage.setItem('sm_cart', JSON.stringify(cart));
  renderCart();
}

function renderCart() {
  $('#cart-count').textContent = cart.length;
  const itemsDiv = $('#cart-items');
  itemsDiv.innerHTML = '';
  let total = 0;
  cart.forEach((c, idx) => {
    total += c.price;
    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = \`
      <strong>\${c.title}</strong><br>
      <span style="color:var(--muted);">\${c.price} cr</span>
      <button class="btn small secondary" style="float:right;" onclick="removeFromCart(\${idx})">‚úï</button>
    \`;
    itemsDiv.appendChild(div);
  });
  $('#cart-total').textContent = total;
}

function removeFromCart(index) {
  cart.splice(index, 1);
  localStorage.setItem('sm_cart', JSON.stringify(cart));
  renderCart();
}

function toggleCart() {
  const drawer = $('#cart-drawer');
  drawer.style.display = drawer.style.display === 'flex' ? 'none' : 'flex';
}

function checkout() {
  if (!cart.length) return alert('Cart is empty.');
  const order = {
    id: Date.now(),
    items: cart.slice(),
    total: cart.reduce((s, c) => s + c.price, 0),
    time: new Date().toLocaleString()
  };
  orders.push(order);
  localStorage.setItem('sm_orders', JSON.stringify(orders));
  cart = [];
  localStorage.setItem('sm_cart', JSON.stringify(cart));
  renderCart();
  renderOrders();
  $('#stat-orders').textContent = orders.length;
  alert('Order created locally (UI only).');
}

/* ORDERS */
function renderOrders() {
  const list = $('#orders-list');
  list.innerHTML = '';
  if (!orders.length) {
    list.innerHTML = '<small style="color:var(--muted);">No orders yet. Checkout from the cart to create one.</small>';
    return;
  }
  orders.slice().reverse().forEach(o => {
    const div = document.createElement('div');
    div.className = 'order-item';
    div.innerHTML = \`
      <strong>Order #\${o.id}</strong> ‚Äî \${o.total} cr<br>
      <small style="color:var(--muted);">\${o.time}</small><br>
      <small style="color:var(--muted);">Items: \${o.items.map(i => i.title).join(', ')}</small>
    \`;
    list.appendChild(div);
  });
}

/* MESSAGES */
function renderThreads() {
  const list = $('#thread-list');
  list.innerHTML = '';
  threads.forEach(t => {
    const div = document.createElement('div');
    div.className = 'thread-item' + (t.id === currentThreadId ? ' active' : '');
    div.onclick = () => openThread(t.id);
    div.innerHTML = \`
      <strong>\${t.name}</strong><br>
      <small style="color:var(--muted);">\${t.preview}</small>
    \`;
    list.appendChild(div);
  });
  $('#stat-threads').textContent = threads.length;
}

function openThread(id) {
  currentThreadId = id;
  const t = threads.find(x => x.id === id);
  if (!t) return;
  $('#thread-header').textContent = 'Thread with ' + t.name;
  $('#msg-input').disabled = false;
  $('#msg-send-btn').disabled = false;
  renderThreadMessages();
  renderThreads();
}

function renderThreadMessages() {
  const t = threads.find(x => x.id === currentThreadId);
  const box = $('#thread-messages');
  box.innerHTML = '';
  if (!t) return;
  t.messages.forEach(m => {
    const div = document.createElement('div');
    div.className = 'msg-bubble ' + (m.from === 'me' ? 'me' : 'them');
    div.innerHTML = \`
      <small style="color:var(--muted);">\${m.from === 'me' ? profile.handle : t.name} ‚Ä¢ \${m.time}</small><br>
      <span>\${m.text}</span>
    \`;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

function sendMessage() {
  const input = $('#msg-input');
  const text = input.value.trim();
  if (!text || !currentThreadId) return;
  const t = threads.find(x => x.id === currentThreadId);
  if (!t) return;
  t.messages.push({
    from: 'me',
    text,
    time: new Date().toLocaleTimeString()
  });
  input.value = '';
  localStorage.setItem('sm_threads', JSON.stringify(threads));
  renderThreadMessages();
}

/* PROFILE */
function renderProfile() {
  $('#profile-handle').value = profile.handle;
  $('#profile-bio').value = profile.bio;
  $('#profile-theme').value = profile.theme;
}

function saveProfile() {
  profile.handle = $('#profile-handle').value.trim() || 'ShadowOwner';
  profile.bio = $('#profile-bio').value.trim();
  profile.theme = $('#profile-theme').value.trim() || '#7b5cff';
  localStorage.setItem('sm_profile', JSON.stringify(profile));
  alert('Profile saved locally.');
}

function resetProfile() {
  profile = {
    handle: 'ShadowOwner',
    bio: 'Owner of this fictional Shadow Market UI.',
    theme: '#7b5cff'
  };
  localStorage.setItem('sm_profile', JSON.stringify(profile));
  renderProfile();
}

/* ADMIN */
function refreshAdminState() {
  const state = {
    listings,
    cart,
    orders,
    threads,
    profile
  };
  $('#admin-state').textContent = JSON.stringify(state, null, 2);
}

/* CLEAR DATA */
function clearAllData() {
  if (!confirm('Clear all local Shadow Market data?')) return;
  cart = [];
  orders = [];
  threads = threadsSeed.slice();
  profile = {
    handle: 'ShadowOwner',
    bio: 'Owner of this fictional Shadow Market UI.',
    theme: '#7b5cff'
  };
  localStorage.removeItem('sm_cart');
  localStorage.removeItem('sm_orders');
  localStorage.removeItem('sm_threads');
  localStorage.removeItem('sm_profile');
  renderCart();
  renderOrders();
  renderThreads();
  renderProfile();
  refreshAdminState();
}

/* INIT */
function init() {
  renderMarket();
  renderCart();
  renderOrders();
  renderThreads();
  renderProfile();
  refreshAdminState();
  $('#stat-orders').textContent = orders.length;
}
init();
</script>

</body>
</html>
